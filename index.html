<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –∞—É–¥–∏—Ç–æ–≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:,">
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .stats-box {
            z-index: 1000;
            position: fixed;
            top: 20px;
            right: 20px;
            width: 280px;
            background: linear-gradient(145deg, #ffffff, #f1f3f5);
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stats-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        .stats-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3436;
            padding: 14px 20px;
            cursor: pointer;
            background: linear-gradient(145deg, #dfe4ea, #ced4da);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }
        .stats-title:hover {
            background: linear-gradient(145deg, #ced4da, #b0b5b9);
        }
        .stats-content {
            max-height: 0;
            opacity: 0;
            padding: 0 20px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
        }
        .stats-content[style*="max-height"] {
            padding: 12px 20px;
        }
        .stats-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #2d3436;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease;
        }
        .stats-item:hover {
            transform: translateX(4px);
            background: rgba(0, 0, 0, 0.04);
            border-radius: 6px;
        }
        .stats-value {
            margin-left: 24px;
            font-size: 14px;
        }
        .reset-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #2d3436;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease;
            background: #3498db;
            color: white;
            padding: 8px;
            border-radius: 6px;
            justify-content: center;
        }
        .reset-filter:hover {
            transform: translateX(4px);
            background: #2980b9;
        }
        .divider {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin: 10px 0;
        }
        .green { color: #2ecc71; }
        .red { color: #e74c3c; }
        .gold { color: #f1c40f; }
        .goal { color: #3498db; }
        .warning { color: #e67e22; }
        .no-audit { color: #7f8c8d; }
        .info { color: #1abc9c; }
        .gold-star i {
            font-size: 18px;
            color: #ffd700;
        }
        .leaflet-control-attribution { display: none; }
        @media (max-width: 600px) {
            .stats-box {
                width: 90%;
                max-width: 300px;
                right: 5%;
                top: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map').setView([59.832213, 30.251091], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // –ì—Ä—É–ø–ø—ã —Å–ª–æ–µ–≤
        const goldenGroup = L.layerGroup().addTo(map);
        const greenGroup = L.layerGroup().addTo(map);
        const redGroup = L.layerGroup().addTo(map);
        const grayGroup = L.layerGroup().addTo(map);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞
        function getColor(status) {
            status = (status || '').toLowerCase().trim();
            const statusMap = {
                "–∑–µ–ª–µ–Ω—ã–π": "green",
                "–∑–µ–ª—ë–Ω—ã–π": "green",
                "–∫—Ä–∞—Å–Ω—ã–π": "red",
                "–∑–æ–ª–æ—Ç–æ–π": "gold"
            };
            return statusMap[status] || "gray";
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(date) {
            if (!date) return '';
            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return date;
                return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:', date);
                return date;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞
        function createPopupText(row) {
            console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É:', row);
            const name = row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'] || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            let popupText = `<b>${name}</b>`;
            const audits = [];
            let auditNum = 1;
            while (true) {
                const dateCol = auditNum > 1 ? `–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞ ${auditNum}` : '–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞';
                const statusCol = auditNum > 1 ? `–°—Ç–∞—Ç—É—Å ${auditNum}` : '–°—Ç–∞—Ç—É—Å';
                const auditorCol = auditNum > 1 ? `–ê—É–¥–∏—Ç–æ—Ä ${auditNum}` : '–ê—É–¥–∏—Ç–æ—Ä';
                const reportCol = auditNum > 1 ? `–û—Ç—á–µ—Ç ${auditNum}` : '–û—Ç—á–µ—Ç';
                if (row[dateCol]) {
                    audits.push({
                        date: row[dateCol],
                        status: row[statusCol] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
                        auditor: row[auditorCol] || null,
                        report: row[reportCol] || null
                    });
                } else {
                    break;
                }
                auditNum++;
            }
            if (!audits.length) {
                audits.push({ date: null, status: '–ï—â—ë –Ω–µ –±—ã–ª–æ –∞—É–¥–∏—Ç–∞ –≤ 2025 –≥–æ–¥—É', auditor: null, report: null });
            }
            audits.forEach(({ date, status, auditor, report }) => {
                if (date) popupText += `<br><br>–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞: ${formatDate(date)}`;
                if (status && status !== '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö') popupText += `<br>–°—Ç–∞—Ç—É—Å: ${status}`;
                if (auditor) popupText += `<br>–ê—É–¥–∏—Ç–æ—Ä: ${auditor}`;
                if (report) popupText += `<br><a href="${report}" target="_blank">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç</a>`;
            });
            if (audits.length > 1) {
                popupText = `<b>${name} (–ê—É–¥–∏—Ç–æ–≤: ${audits.length})</b>` + popupText.slice(`<b>${name}</b>`.length);
            }
            return popupText;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
        function createMarker(row) {
            const lat = row['–®–∏—Ä–æ—Ç–∞'];
            const lon = row['–î–æ–ª–≥–æ—Ç–∞'];
            if (!lat || !lon) {
                console.warn('–ü—Ä–æ–ø—É—â–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è:', row);
                return null;
            }
            const name = row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'] || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const color = getColor(row['–°—Ç–∞—Ç—É—Å']);
            const popupText = createPopupText(row);
            if (name === "–£–ª—å—è–Ω–∫–∞ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥") {
                return L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'gold-star',
                        html: `<i class="fas fa-heart" style="color: ${color}"></i>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).bindPopup(popupText);
            } else if (color === 'gold') {
                return L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'gold-star',
                        html: `<i class="fas fa-star" style="color: gold"></i>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).bindPopup(popupText);
            } else {
                return L.circleMarker([lat, lon], {
                    radius: 8,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7,
                    weight: 1
                }).bindPopup(popupText);
            }
        }

        // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function calculateStatistics(data) {
            console.log('–í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è:', data);
            const now = new Date();
            const oneMonthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
            const currentYear = now.getFullYear();
            let goldenAudits = 0, greenAudits = 0, redAudits = 0, oldAudits = 0, withoutAudits = 0;
            let latestAudit = { date: null, restaurant: null };

            data.forEach(row => {
                const status = (row['–°—Ç–∞—Ç—É—Å'] || '').toLowerCase().trim();
                if (status === '–∑–æ–ª–æ—Ç–æ–π') goldenAudits++;
                else if (status === '–∑–µ–ª–µ–Ω—ã–π' || status === '–∑–µ–ª—ë–Ω—ã–π') greenAudits++;
                else if (status === '–∫—Ä–∞—Å–Ω—ã–π') redAudits++;

                const auditDate = row['–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞'] ? new Date(row['–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞']) : null;
                if (!auditDate || auditDate < oneMonthAgo) oldAudits++;

                let hasAuditInYear = auditDate && auditDate.getFullYear() === currentYear;
                if (!hasAuditInYear) {
                    let auditNum = 1;
                    while (true) {
                        const dateCol = auditNum > 1 ? `–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞ ${auditNum}` : '–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞';
                        if (row[dateCol]) {
                            const date = new Date(row[dateCol]);
                            if (date.getFullYear() === currentYear) {
                                hasAuditInYear = true;
                            }
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞—É–¥–∏—Ç–∞
                            if (date && (!latestAudit.date || date > latestAudit.date)) {
                                latestAudit = {
                                    date: date,
                                    restaurant: row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'] || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'
                                };
                            }
                        } else {
                            break;
                        }
                        auditNum++;
                    }
                }
                if (!hasAuditInYear) withoutAudits++;

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞—É–¥–∏—Ç–∞
                if (auditDate && (!latestAudit.date || auditDate > latestAudit.date)) {
                    latestAudit = {
                        date: auditDate,
                        restaurant: row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'] || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'
                    };
                }
            });

            const totalAudits = goldenAudits + greenAudits + redAudits;
            const goalPercentage = totalAudits > 0 ? Math.round(((goldenAudits + greenAudits) / totalAudits) * 1000) / 10 : 0;

            return {
                goldenAudits,
                greenAudits,
                redAudits,
                oldAudits,
                goalPercentage,
                withoutAudits,
                latestAudit: latestAudit.date ? {
                    date: formatDate(latestAudit.date),
                    restaurant: latestAudit.restaurant
                } : null
            };
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
        function filterMarkers(filterType) {
            console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä:', filterType);
            goldenGroup.clearLayers();
            greenGroup.clearLayers();
            redGroup.clearLayers();
            grayGroup.clearLayers();
            data.forEach(row => {
                const marker = createMarker(row);
                if (!marker) return;
                const color = getColor(row['–°—Ç–∞—Ç—É—Å']);
                const auditDate = row['–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞'] ? new Date(row['–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞']) : null;
                const currentYear = new Date().getFullYear();
                let hasAuditInYear = auditDate && auditDate.getFullYear() === currentYear;
                if (!hasAuditInYear) {
                    let auditNum = 1;
                    while (true) {
                        const dateCol = auditNum > 1 ? `–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞ ${auditNum}` : '–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞';
                        if (row[dateCol]) {
                            const date = new Date(row[dateCol]);
                            if (date.getFullYear() === currentYear) {
                                hasAuditInYear = true;
                                break;
                            }
                        } else {
                            break;
                        }
                        auditNum++;
                    }
                }
                if (filterType === 'all') {
                    if (color === 'gold') marker.addTo(goldenGroup);
                    else if (color === 'green') marker.addTo(greenGroup);
                    else if (color === 'red') marker.addTo(redGroup);
                    else marker.addTo(grayGroup);
                } else if (filterType === 'golden' && color === 'gold') {
                    marker.addTo(goldenGroup);
                } else if (filterType === 'green' && color === 'green') {
                    marker.addTo(greenGroup);
                } else if (filterType === 'red' && color === 'red') {
                    marker.addTo(redGroup);
                } else if (filterType === 'no-audit' && !hasAuditInYear) {
                    marker.addTo(grayGroup);
                }
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–ª–æ–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function renderStats(stats) {
            console.log('–û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:', stats);
            const latestAuditText = stats.latestAudit
                ? `${stats.latestAudit.date} (${stats.latestAudit.restaurant})`
                : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            const statsHtml = `
                <div class="stats-box">
                    <div class="stats-title" onclick="toggleStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—É–¥–∏—Ç–æ–≤</div>
                    <div class="stats-content">
                        <div class="reset-filter" onclick="filterMarkers('all')"><span class="goal">üåê</span> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã</div>
                        <div class="stats-item" onclick="filterMarkers('golden')">
                            <div><span class="gold">‚≠ê</span> –ó–æ–ª–æ—Ç—ã–µ –∞—É–¥–∏—Ç—ã: ${stats.goldenAudits}</div>
                        </div>
                        <div class="stats-item" onclick="filterMarkers('green')">
                            <div><span class="green">‚úÖ</span> –ó–µ–ª–µ–Ω—ã–µ –∞—É–¥–∏—Ç—ã: ${stats.greenAudits}</div>
                        </div>
                        <div class="stats-item" onclick="filterMarkers('red')">
                            <div><span class="red">‚ùå</span> –ö—Ä–∞—Å–Ω—ã–µ –∞—É–¥–∏—Ç—ã: ${stats.redAudits}</div>
                        </div>
                        <div class="stats-item" onclick="filterMarkers('no-audit')">
                            <div><span class="no-audit">üö´</span> –†–µ—Å—Ç–æ—Ä–∞–Ω—ã –±–µ–∑ –∞—É–¥–∏—Ç–∞ –≤ 2025: ${stats.withoutAudits}</div>
                        </div>
                        <div class="divider"></div>
                        <div class="stats-item">
                            <div><span class="goal">üéØ</span> % –≤ —Ü–µ–ª–∏: ${stats.goalPercentage}%</div>
                        </div>
                        <div class="stats-item">
                            <div><span class="warning">‚è≥</span> –ë–µ–∑ –∞—É–¥–∏—Ç–∞ > –º–µ—Å—è—Ü–∞: ${stats.oldAudits}</div>
                        </div>
                        <div class="stats-item">
                            <div><span class="info">üïí</span> –ü–æ—Å–ª–µ–¥–Ω–∏–π –∞—É–¥–∏—Ç:</div>
                            <div class="stats-value">${latestAuditText}</div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', statsHtml);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function toggleStats() {
            const content = document.querySelector(".stats-content");
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                content.style.opacity = 0;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                content.style.opacity = 1;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
        let data = []; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            try {
                const response = await fetch('https://restaurant-map.onrender.com/api/restaurants');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ HTTP: ' + response.status);
                const fetchedData = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', fetchedData);
                if (!fetchedData || !Array.isArray(fetchedData)) {
                    throw new Error('–î–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º');
                }
                if (fetchedData.length > 0) {
                    console.log('–ö–ª—é—á–∏ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏:', Object.keys(fetchedData[0]));
                }
                data = fetchedData;
                goldenGroup.clearLayers();
                greenGroup.clearLayers();
                redGroup.clearLayers();
                grayGroup.clearLayers();
                data.forEach(row => {
                    const marker = createMarker(row);
                    if (marker) {
                        const color = getColor(row['–°—Ç–∞—Ç—É—Å']);
                        if (color === 'green') marker.addTo(greenGroup);
                        else if (color === 'red') marker.addTo(redGroup);
                        else if (color === 'gold') marker.addTo(goldenGroup);
                        else marker.addTo(grayGroup);
                    }
                });
                const stats = calculateStatistics(data);
                document.querySelector('.stats-box')?.remove();
                renderStats(stats);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            }
        }

        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        loadData();
    </script>
</body>
</html>