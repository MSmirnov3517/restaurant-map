<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –∞—É–¥–∏—Ç–æ–≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:,">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .stats-box {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 1000;
            max-width: 320px;
            min-width: 250px;
        }

        .stats-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .stats-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .stats-content.show {
            opacity: 1;
        }

        .section-title {
            font-size: 1em;
            font-weight: 600;
            color: #555;
            margin: 15px 0 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-item, .filter-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
            color: #333;
        }

        .stats-item:hover, .filter-item:hover {
            background: #f5f5f5;
        }

        .stats-item .gold, .filter-item .gold {
            color: #FFD700;
        }

        .stats-item .green, .filter-item .green {
            color: #28A745;
        }

        .stats-item .red, .filter-item .red {
            color: #DC3545;
        }

        .stats-item .no-audit, .filter-item .no-audit {
            color: #6C757D;
        }

        .reset-filter {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
            color: #007BFF;
            font-weight: 500;
        }

        .reset-filter:hover {
            background: #e6f0fa;
        }

        .filter-item.active-market {
            background: #e9ecef;
            font-weight: 500;
        }

        .territory-item {
            margin-left: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .territory-item.show {
            max-height: 500px;
        }

        .latest-audit {
            font-size: 0.9em;
            color: #444;
        }

        .latest-audit strong {
            display: block;
            margin: 8px 0 4px;
            font-weight: 600;
        }

        .latest-audit ul {
            margin: 0;
            padding-left: 20px;
            list-style: disc;
        }

        .latest-audit li {
            margin-bottom: 5px;
        }

        @media (max-width: 600px) {
            .stats-box {
                top: 10px;
                right: 10px;
                max-width: 90%;
                min-width: 200px;
            }

            .stats-title {
                font-size: 1.1em;
            }

            .stats-item, .filter-item, .reset-filter {
                font-size: 0.9em;
                padding: 6px 8px;
            }
        }

        .leaflet-control-attribution {
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map', {
            attributionControl: false
        }).setView([59.832213, 30.251091], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // –ì—Ä—É–ø–ø—ã —Å–ª–æ–µ–≤
        const goldenGroup = L.layerGroup().addTo(map);
        const greenGroup = L.layerGroup().addTo(map);
        const redGroup = L.layerGroup().addTo(map);
        const grayGroup = L.layerGroup().addTo(map);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞
        function getColor(row) {
            let auditsInYear = [];
            let auditNum = 1;

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∞—É–¥–∏—Ç—ã –∑–∞ 2025 –≥–æ–¥
            while (true) {
                const dateCol = auditNum > 1 ? `–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞ ${auditNum}` : '–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞';
                const statusCol = auditNum > 1 ? `–°—Ç–∞—Ç—É—Å ${auditNum}` : '–°—Ç–∞—Ç—É—Å';
                if (row[dateCol]) {
                    const date = new Date(row[dateCol]);
                    if (!isNaN(date.getTime())) {
                        auditsInYear.push({
                            date: date,
                            status: (row[statusCol] || '').toLowerCase().trim()
                        });
                    }
                } else {
                    break;
                }
                auditNum++;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞—É–¥–∏—Ç—ã –ø–æ –¥–∞—Ç–µ (–æ—Ç –ø–æ–∑–¥–Ω–µ–≥–æ –∫ —Ä–∞–Ω–Ω–µ–º—É)
            auditsInYear.sort((a, b) => b.date - a.date);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è
            if (auditsInYear.length === 0) {
                console.log('Restaurant:', row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'], 'Audits:', auditsInYear, 'Color:', 'gray');
                return 'gray'; // –ù–µ—Ç –∞—É–¥–∏—Ç–æ–≤
            }

            const lastAudit = auditsInYear[0].status;
            if (lastAudit === '–∫—Ä–∞—Å–Ω—ã–π') {
                console.log('Restaurant:', row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'], 'Audits:', auditsInYear, 'Color:', 'red');
                return 'red';
            }
            if (lastAudit === '–∑–æ–ª–æ—Ç–æ–π') {
                console.log('Restaurant:', row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'], 'Audits:', auditsInYear, 'Color:', 'gold');
                return 'gold';
            }
            if (lastAudit === '–∑–µ–ª–µ–Ω—ã–π' || lastAudit === '–∑–µ–ª—ë–Ω—ã–π') {
                const greenCount = auditsInYear.filter(a => a.status === '–∑–µ–ª–µ–Ω—ã–π' || a.status === '–∑–µ–ª—ë–Ω—ã–π').length;
                if (greenCount >= 2) {
                    console.log('Restaurant:', row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'], 'Audits:', auditsInYear, 'Color:', 'green');
                    return 'green';
                }
            }
            console.log('Restaurant:', row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'], 'Audits:', auditsInYear, 'Color:', 'gray');
            return 'gray'; // –ú–µ–Ω—å—à–µ –¥–≤—É—Ö –∑–µ–ª–µ–Ω—ã—Ö –∞—É–¥–∏—Ç–æ–≤ –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–ª—É—á–∞–∏
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(date) {
            if (!date) return '';
            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return date;
                return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:', date);
                return date;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞
        function createPopupText(row) {
            const name = row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'] || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const market = row['–ú–∞—Ä–∫–µ—Ç'] || '–ù–µ —É–∫–∞–∑–∞–Ω';
            const territory = row['–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è'] || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            let popupText = `<b>${name}</b><br>–ú–∞—Ä–∫–µ—Ç: ${market}<br>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è: ${territory}`;
            const audits = [];
            const currentYear = new Date().getFullYear();
            let auditNum = 1;

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∞—É–¥–∏—Ç—ã
            while (true) {
                const dateCol = auditNum > 1 ? `–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞ ${auditNum}` : '–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞';
                const statusCol = auditNum > 1 ? `–°—Ç–∞—Ç—É—Å ${auditNum}` : '–°—Ç–∞—Ç—É—Å';
                const auditorCol = auditNum > 1 ? `–ê—É–¥–∏—Ç–æ—Ä ${auditNum}` : '–ê—É–¥–∏—Ç–æ—Ä';
                const reportCol = auditNum > 1 ? `–û—Ç—á–µ—Ç ${auditNum}` : '–û—Ç—á–µ—Ç';
                if (row[dateCol]) {
                    const date = new Date(row[dateCol]);
                    if (date.getFullYear() === currentYear) {
                        audits.push({
                            date: row[dateCol],
                            status: row[statusCol] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
                            auditor: row[auditorCol] || null,
                            report: row[reportCol] || null
                        });
                    }
                } else {
                    break;
                }
                auditNum++;
            }

            // –ï—Å–ª–∏ –Ω–µ—Ç –∞—É–¥–∏—Ç–æ–≤ –≤ 2025 –≥–æ–¥—É
            if (!audits.length) {
                audits.push({ date: null, status: '–ï—â—ë –Ω–µ –±—ã–ª–æ –∞—É–¥–∏—Ç–∞ –≤ 2025 –≥–æ–¥—É', auditor: null, report: null });
            }

            audits.forEach(({ date, status, auditor, report }) => {
                if (date) popupText += `<br><br>–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞: ${formatDate(date)}`;
                if (status && status !== '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö') popupText += `<br>–°—Ç–∞—Ç—É—Å: ${status}`;
                if (auditor) popupText += `<br>–ê—É–¥–∏—Ç–æ—Ä: ${auditor}`;
                if (report) popupText += `<br><a href="${report}" target="_blank">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç</a>`;
            });

            if (audits.length > 1) {
                popupText = `<b>${name} (–ê—É–¥–∏—Ç–æ–≤: ${audits.length})</b><br>–ú–∞—Ä–∫–µ—Ç: ${market}<br>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è: ${territory}` + popupText.slice(`<b>${name}</b><br>–ú–∞—Ä–∫–µ—Ç: ${market}<br>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è: ${territory}`.length);
            }

            return popupText;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
        function createMarker(row) {
            const lat = row['–®–∏—Ä–æ—Ç–∞'];
            const lon = row['–î–æ–ª–≥–æ—Ç–∞'];

            if (!lat || !lon || isNaN(parseFloat(lat)) || isNaN(parseFloat(lon))) {
                console.warn('Invalid coordinates for:', row);
                return null;
            }

            const name = row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'] || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const color = getColor(row);
            const popupText = createPopupText(row);

            if (name === "–£–ª—å—è–Ω–∫–∞ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥") {
                return L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'gold-star',
                        html: `<i class="fas fa-heart" style="color: ${color}"></i>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).bindPopup(popupText);
            } else if (color === 'gold') {
                return L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'gold-star',
                        html: `<i class="fas fa-star" style="color: gold"></i>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).bindPopup(popupText);
            } else {
                return L.circleMarker([lat, lon], {
                    radius: 8,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7,
                    weight: 1
                }).bindPopup(popupText);
            }
        }

        // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function calculateStatistics(data, filterMarket = null, filterTerritory = null) {
            const currentYear = new Date().getFullYear();
            let goldenAudits = 0, greenAudits = 0, redAudits = 0, grayRestaurants = 0;
            const auditDates = {};

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–∞—Ä–∫–µ—Ç—É –∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
            let filteredData = data;
            if (filterMarket) {
                filteredData = filteredData.filter(row => row['–ú–∞—Ä–∫–µ—Ç'] === filterMarket);
            }
            if (filterTerritory) {
                filteredData = filteredData.filter(row => row['–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è'] === filterTerritory);
            }

            filteredData.forEach(row => {
                let auditsInYear = [];
                let auditNum = 1;

                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∞—É–¥–∏—Ç—ã –∑–∞ 2025 –≥–æ–¥
                while (true) {
                    const dateCol = auditNum > 1 ? `–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞ ${auditNum}` : '–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞';
                    const statusCol = auditNum > 1 ? `–°—Ç–∞—Ç—É—Å ${auditNum}` : '–°—Ç–∞—Ç—É—Å';
                    if (row[dateCol]) {
                        const date = new Date(row[dateCol]);
                        if (date.getFullYear() === currentYear) {
                            const status = (row[statusCol] || '').toLowerCase().trim();
                            auditsInYear.push({
                                date: date,
                                status: status
                            });
                            // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                            if (status === '–∑–æ–ª–æ—Ç–æ–π') goldenAudits++;
                            else if (status === '–∑–µ–ª–µ–Ω—ã–π' || status === '–∑–µ–ª—ë–Ω—ã–π') greenAudits++;
                            else if (status === '–∫—Ä–∞—Å–Ω—ã–π') redAudits++;
                        }
                    } else {
                        break;
                    }
                    auditNum++;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –¥–ª—è —Å–µ—Ä–æ–≥–æ —Ü–≤–µ—Ç–∞
                if (auditsInYear.length === 0) {
                    grayRestaurants++;
                } else {
                    auditsInYear.sort((a, b) => b.date - a.date);
                    const lastAudit = auditsInYear[0].status;
                    if (lastAudit !== '–∫—Ä–∞—Å–Ω—ã–π' && lastAudit !== '–∑–æ–ª–æ—Ç–æ–π') {
                        const greenCount = auditsInYear.filter(a => a.status === '–∑–µ–ª–µ–Ω—ã–π' || a.status === '–∑–µ–ª—ë–Ω—ã–π').length;
                        if (greenCount < 2) {
                            grayRestaurants++;
                        }
                    }
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—ã –∞—É–¥–∏—Ç–æ–≤
                auditsInYear.forEach(audit => {
                    if (audit.date && !isNaN(audit.date.getTime())) {
                        const dateStr = formatDate(audit.date);
                        if (!auditDates[dateStr]) auditDates[dateStr] = [];
                        auditDates[dateStr].push(row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'] || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
                    }
                });
            });

            const latestAudits = Object.keys(auditDates)
                .map(dateStr => ({
                    date: new Date(dateStr.split('.').reverse().join('-')),
                    formattedDate: dateStr,
                    restaurants: auditDates[dateStr]
                }))
                .filter(audit => !isNaN(audit.date.getTime()))
                .sort((a, b) => b.date - a.date)
                .slice(0, 2);

            return {
                goldenAudits,
                greenAudits,
                redAudits,
                grayRestaurants,
                latestAudits,
                filteredData
            };
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
        function filterMarkers(filterType, filterMarket = null, filterTerritory = null) {
            const currentYear = new Date().getFullYear();
            goldenGroup.clearLayers();
            greenGroup.clearLayers();
            redGroup.clearLayers();
            grayGroup.clearLayers();

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–∞—Ä–∫–µ—Ç—É –∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
            let filteredData = data;
            if (filterMarket) {
                filteredData = filteredData.filter(row => row['–ú–∞—Ä–∫–µ—Ç'] === filterMarket);
            }
            if (filterTerritory) {
                filteredData = filteredData.filter(row => row['–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è'] === filterTerritory);
            }

            filteredData.forEach(row => {
                const lat = row['–®–∏—Ä–æ—Ç–∞'];
                const lon = row['–î–æ–ª–≥–æ—Ç–∞'];

                if (isNaN(parseFloat(lat)) || isNaN(parseFloat(lon))) {
                    console.warn("Invalid coordinates for:", row);
                    return;
                }

                const marker = createMarker(row);
                if (!marker) return;

                const color = getColor(row);
                let auditsInYear = [];
                let auditNum = 1;

                // –°–æ–±–∏—Ä–∞–µ–º –∞—É–¥–∏—Ç—ã –∑–∞ 2025 –≥–æ–¥
                while (true) {
                    const dateCol = auditNum > 1 ? `–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞ ${auditNum}` : '–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞';
                    const statusCol = auditNum > 1 ? `–°—Ç–∞—Ç—É—Å ${auditNum}` : '–°—Ç–∞—Ç—É—Å';
                    if (row[dateCol]) {
                        const date = new Date(row[dateCol]);
                        if (date.getFullYear() === currentYear) {
                            auditsInYear.push({
                                date: date,
                                status: (row[statusCol] || '').toLowerCase().trim()
                            });
                        }
                    } else {
                        break;
                    }
                    auditNum++;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –¥–ª—è —Å–µ—Ä–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
                const hasNoAudit = auditsInYear.length === 0;
                const greenCount = auditsInYear.filter(a => a.status === '–∑–µ–ª–µ–Ω—ã–π' || a.status === '–∑–µ–ª—ë–Ω—ã–π').length;
                const isGray = hasNoAudit || (auditsInYear.length > 0 && greenCount < 2);

                if (filterType === 'all') {
                    if (color === 'gold') marker.addTo(goldenGroup);
                    else if (color === 'green') marker.addTo(greenGroup);
                    else if (color === 'red') marker.addTo(redGroup);
                    else marker.addTo(grayGroup);
                } else if (filterType === 'no-audit' && isGray) {
                    marker.addTo(grayGroup);
                }
            });

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const stats = calculateStatistics(data, filterMarket, filterTerritory);
            document.querySelector('.stats-box')?.remove();
            renderStats(stats, filterMarket, filterTerritory);
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–ª–æ–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function renderStats(stats, currentMarket = null, currentTerritory = null) {
            const markets = [...new Set(data.map(row => row['–ú–∞—Ä–∫–µ—Ç']).filter(Boolean))];
            const territoriesByMarket = {};

            markets.forEach(market => {
                territoriesByMarket[market] = [...new Set(
                    data.filter(row => row['–ú–∞—Ä–∫–µ—Ç'] === market).map(row => row['–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è']).filter(Boolean)
                )];
            });

            const latestAuditsHtml = stats.latestAudits && stats.latestAudits.length > 0
                ? stats.latestAudits.map(audit => `
                    <strong>${audit.formattedDate}</strong>
                    <ul>
                        ${audit.restaurants.map(restaurant => `<li>${restaurant}</li>`).join('')}
                    </ul>
                `).join('')
                : '<strong>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</strong>';

            let filtersHtml = '';
            if (markets.length > 0) {
                filtersHtml = `
                    <div class="section-title">üè¢ –§–∏–ª—å—Ç—Ä—ã –ø–æ –º–∞—Ä–∫–µ—Ç–∞–º</div>
                    ${markets.map(market => {
                        const isActive = market === currentMarket;
                        return `
                            <div class="filter-item market-item ${isActive ? 'active-market' : ''}"
                                 onclick="handleMarketClick('${market}')">
                                <span>${isActive ? 'üìå' : 'üè¢'}</span> ${market || '–ë–µ–∑ –º–∞—Ä–∫–µ—Ç–∞'}
                            </div>
                            ${isActive ? `
                                <div id="territories-${market.replace(/[^a-z0-9]/gi, '-')}" class="territory-item show">
                                    ${territoriesByMarket[market].map(territory => `
                                        <div class="filter-item"
                                             onclick="filterMarkers('all', '${market}', '${territory}')">
                                            <span>${territory === currentTerritory ? 'üìç' : 'üó∫Ô∏è'}</span> ${territory || '–ë–µ–∑ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏'}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        `;
                    }).join('')}
                `;
            }

            const statsHtml = `
                <div class="stats-box">
                    <div class="stats-title" onclick="toggleStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—É–¥–∏—Ç–æ–≤</div>
                    <div class="stats-content">
                        <div class="reset-filter" onclick="filterMarkers('all')">
                            <span class="goal">üåê</span> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
                        </div>
                        <div class="section-title">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</div>
                        <div class="stats-item">
                            <span class="gold">‚≠ê</span> –ó–æ–ª–æ—Ç—ã–µ –∞—É–¥–∏—Ç—ã: <strong>${stats.goldenAudits}</strong>
                        </div>
                        <div class="stats-item">
                            <span class="green">‚úÖ</span> –ó–µ–ª–µ–Ω—ã–µ –∞—É–¥–∏—Ç—ã: <strong>${stats.greenAudits}</strong>
                        </div>
                        <div class="stats-item">
                            <span class="red">‚ùå</span> –ö—Ä–∞—Å–Ω—ã–µ –∞—É–¥–∏—Ç—ã: <strong>${stats.redAudits}</strong>
                        </div>
                        <div class="stats-item" onclick="filterMarkers('no-audit', '${currentMarket || ''}', '${currentTerritory || ''}')">
                            <span class="no-audit">üö´</span> –ë–µ–∑ –∞—É–¥–∏—Ç–∞ –∏–ª–∏ –º–µ–Ω—å—à–µ –¥–≤—É—Ö –∑–µ–ª–µ–Ω—ã—Ö: <strong>${stats.grayRestaurants}</strong>
                        </div> ${filtersHtml}
                        <div class="section-title">üïí –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞—É–¥–∏—Ç—ã</div>
                        <div class="latest-audit">
                            ${latestAuditsHtml}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', statsHtml);

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            const content = document.querySelector(".stats-content");
            content.style.maxHeight = content.scrollHeight + "px";
            content.style.opacity = 1;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –º–∞—Ä–∫–µ—Ç—É
        function handleMarketClick(market) {
            filterMarkers('all', market, null);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function toggleStats() {
            const content = document.querySelector(".stats-content");
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                content.style.opacity = 0;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                content.style.opacity = 1;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
        let data = [];
        async function loadData() {
            try {
                const apiBaseUrl = window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1') ? '' : 'https://restaurant-map.onrender.com';
                const response = await fetch(`${apiBaseUrl}/api/restaurants`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error ${response.status}: ${errorText}`);
                }
                const fetchedData = await response.json();
                if (!fetchedData || !Array.isArray(fetchedData)) {
                    throw new Error('Data is not an array');
                }
                data = fetchedData;

                goldenGroup.clearLayers();
                greenGroup.clearLayers();
                redGroup.clearLayers();
                grayGroup.clearLayers();

                data.forEach(row => {
                    const lat = row['–®–∏—Ä–æ—Ç–∞'];
                    const lon = row['–î–æ–ª–≥–æ—Ç–∞'];

                    if (isNaN(parseFloat(lat)) || isNaN(parseFloat(lon))) {
                        console.warn("Invalid coordinates for:", row);
                        return;
                    }

                    const marker = createMarker(row);
                    if (marker) {
                        const color = getColor(row);
                        if (color === 'green') marker.addTo(greenGroup);
                        else if (color === 'red') marker.addTo(redGroup);
                        else if (color === 'gold') marker.addTo(goldenGroup);
                        else marker.addTo(grayGroup);
                    }
                });

                const stats = calculateStatistics(data);
                document.querySelector('.stats-box')?.remove();
                renderStats(stats);

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        loadData();
    </script>
</body>
</html>